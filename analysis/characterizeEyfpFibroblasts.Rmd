---
title: "characterize eyfp pos"
author: "Mechthild LÃ¼tge"
date: "14 May 2020"
output:
  html_document:
    self_contained: no
    code_folding: show
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float: true
    collapsed: no
    smooth_scroll: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dev = c("png", "pdf"))
set.seed(1000)
```

## load packages
```{r libs}
suppressPackageStartupMessages({
  library(SingleCellExperiment)
  library(tidyverse)
  library(Seurat)
  library(magrittr)
  library(dplyr)
  library(purrr)
  library(ggplot2)
  library(here)
  library(runSeurat3)
  library(ggsci)
  library(ggpubr)
  library(pheatmap)
  library(RColorBrewer)
  library(CellMixS)
})

```

## set dir
```{r set dir}
basedir <- here()
seurat <- readRDS(file = paste0(basedir, 
                                "/data/TCRM_all10samplesMerged_seurat.rds"))

seurat$time_plus_grp <- paste0(seurat$time, "_", seurat$grp)

dim(seurat)
seurat <- subset(seurat, subset = Rosa26eyfp.Rosa26eyfp > 0)
seurat <- rerunSeurat3(seurat)
dim(seurat)

```



## color vectors
```{r colVec}

colPal <- pal_igv()(length(levels(seurat)))
colGrp <- pal_jama()(length(unique(seurat$grp)))
colSmp <- c(pal_uchicago()(8), pal_npg()(8))[1:length(unique(seurat$dataset))]
colTime <- pal_npg()(length(unique(seurat$time)))

names(colPal) <- levels(seurat)
names(colGrp) <- unique(seurat$grp)
names(colSmp) <- unique(seurat$dataset)
names(colTime) <- unique(seurat$time)

```


## vis data {.tabset}
### clusters
```{r vis cluster}
DimPlot(seurat, reduction = "umap", cols=colPal)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```

### group
```{r vis grp}

DimPlot(seurat, reduction = "umap", group.by = "grp", cols=colGrp)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

```


### Sample
```{r vis sample}

DimPlot(seurat, reduction = "umap", group.by = "dataset", cols=colSmp)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```

### batch
```{r vis batch}

DimPlot(seurat, reduction = "umap", group.by = "batch")+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```

### timepoint
```{r vis timepoint}

DimPlot(seurat, reduction = "umap", group.by = "time", cols=colTime)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```

## marker genes
```{r marker genes}
Idents(seurat) <- seurat$seurat_clusters
seurat_markers_all <- FindAllMarkers(object = seurat, assay ="RNA",
                                     only.pos = TRUE, min.pct = 0.25,
                                     logfc.threshold = 0.25,
                                     test.use = "wilcox")

```


## save objects
```{r save objects}

saveRDS(seurat, paste0(basedir,
                       "/data/TCRM_all10samplesMerged_eyfpOnly_seurat.rds"))

write.table(seurat_markers_all, file=paste0(basedir, 
            "/data/TCRM_all10samplesMerged_eyfpOnly_markerGenes.txt"),
            row.names = FALSE, col.names = TRUE, quote = FALSE, sep = "\t")


```


## gene signatures {.tabset}
```{r define gene signatures}

c0Sig <- data.frame(gene=c("Ckb","Smoc2","Thbs1","Spon2","Rpl26","Col5a3")) %>%
  mutate(signature="C0")

c1Sig <- data.frame(gene=c("Rbp4","Eln","Mt1","Mfap4","Nr4a1","Apoe")) %>% 
  mutate(signature="C1")

c5Sig <- data.frame(gene=c("Dbp","Col8a1","Cst6","Nr1d1","Kcnk2","Fibin")) %>%
  mutate(signature="C5")

c7Sig <- data.frame(gene=c("Ecrg4","Wif1","Prg4","Clu","Dkk3","Pdlim3")) %>%
  mutate(signature="C7")

c10Sig <- data.frame(gene=c("Tnnt2","Myl7","Tnni3","Mb","Myl3","Acta1")) %>%
  mutate(signature="C10")

allGenes <- data.frame(geneID = rownames(seurat)) %>%
  mutate(gene=gsub("^.*\\.","", geneID))
allSign <- rbind(c0Sig, c1Sig, c5Sig, c7Sig, c10Sig) %>%
  left_join(., allGenes, by="gene")

```


### map signature on umap {.tabset}
```{r map sign}
sce <- as.SingleCellExperiment(seurat)
sigNam <- unique(allSign$signature)

template_dp <- c(
    "#### {{sig}}\n",
    "```{r map sign {{sig}},fig.height=3.5, fig.width=4.5, echo = FALSE}\n",
    "sign <- as.character('{{sig}}')",
    "signGenes <- allSign %>% dplyr::filter(signature == sign)",
    "sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]",
    "cntMat <- rowSums(
                t(as.matrix(sceSub@assays@data$logcounts)))/nrow(signGenes)",
    "sceSub$sign <- cntMat",
    "maxCM <- max(cntMat)",
    "minCM <- min(cntMat)",
    "pal = colorRampPalette(rev(brewer.pal(11, 'RdBu')))",
    "sc <- scale_colour_gradientn(colours = pal(100), limits=c(minCM,maxCM),
    na.value = pal(100)[100])",
    "p <- visGroup(sceSub, 'sign', dim_red = 'UMAP') +
    sc +
    guides(colour = guide_colourbar(title = '')) +
    ggtitle(paste0(sign, ' signature')) +
    theme_classic() + 
    theme(axis.text = element_blank(),
          axis.ticks = element_blank()) +
    labs(x='Dimension 1', y='Dimension 2')",
    "p\n",
    "```\n",
    "\n"
)


plots_dp <- lapply(sigNam, 
  function(sig) knitr::knit_expand(text = template_dp)
)

```

`r knitr::knit(text = unlist(plots_dp))`

### map signature on umap each timepoint plus cond {.tabset}
```{r map sign time}

template_dpt <- c(
    "#### {{sig}}\n",
    "```{r map sign time {{sig}},fig.height=3.5, fig.width=4.5, echo = FALSE}\n",
    "sign <- as.character('{{sig}}')",
    "signGenes <- allSign %>% dplyr::filter(signature == sign)",
    "pList <- NULL",
    "for(i in 1:length(unique(sce$time_plus_grp))){",
      "tiP <- unique(sce$time_plus_grp)[i]",
      "sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]",
      "sceSub <- sceSub[,sceSub$time_plus_grp == tiP]",
      "cntMat <- rowSums(
                t(as.matrix(sceSub@assays@data$logcounts)))/nrow(signGenes)",
      "sceSub$sign <- cntMat",
      "maxCM <- max(cntMat)",
      "minCM <- min(cntMat)",
      "pal = colorRampPalette(rev(brewer.pal(11, 'RdBu')))",
      "sc <- scale_colour_gradientn(colours = pal(100), limits=c(minCM,maxCM),
      na.value = pal(100)[100])",
      "p <- visGroup(sceSub, 'sign', dim_red = 'UMAP') +
      sc +
      guides(colour = guide_colourbar(title = '')) +
      ggtitle(paste0(sign, ' signature ', tiP)) +
      theme_classic() + 
      theme(axis.text = element_blank(),
          axis.ticks = element_blank()) +
      labs(x='Dimension 1', y='Dimension 2')",
      "pList[[i]] <- p}",
    "pList\n",
    "```\n",
    "\n"
)


plots_dpt <- lapply(sigNam, 
  function(sig) knitr::knit_expand(text = template_dpt)
)


```

`r knitr::knit(text = unlist(plots_dpt))`


### map signature on umap cutoff 2 {.tabset}
```{r map sign cut 2}
sce <- as.SingleCellExperiment(seurat)
sigNam <- unique(allSign$signature)

template_dp <- c(
    "#### {{sig}}\n",
    "```{r map sign cut 2 {{sig}},fig.height=3.5, fig.width=4.5, echo = FALSE}\n",
    "sign <- as.character('{{sig}}')",
    "signGenes <- allSign %>% dplyr::filter(signature == sign)",
    "sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]",
    "cntMat <- rowSums(
                t(as.matrix(sceSub@assays@data$logcounts)))/nrow(signGenes)",
    "sceSub$sign <- cntMat",
    "maxCM <- max(cntMat)",
    "minCM <- min(cntMat)",
    "maxCM <- 2",
    "pal = colorRampPalette(rev(brewer.pal(11, 'RdBu')))",
    "sc <- scale_colour_gradientn(colours = pal(100), limits=c(minCM,maxCM),
    na.value = pal(100)[100])",
    "p <- visGroup(sceSub, 'sign', dim_red = 'UMAP') +
    sc +
    guides(colour = guide_colourbar(title = '')) +
    ggtitle(paste0(sign, ' signature')) +
    theme_classic() + 
    theme(axis.text = element_blank(),
          axis.ticks = element_blank()) +
    labs(x='Dimension 1', y='Dimension 2')",
    "p\n",
    "```\n",
    "\n"
)


plots_dp <- lapply(sigNam, 
  function(sig) knitr::knit_expand(text = template_dp)
)

```

`r knitr::knit(text = unlist(plots_dp))`

### map signature on umap each timepoint plus cond cut 2 {.tabset}
```{r map sign time cut 2}

template_dpt <- c(
    "#### {{sig}}\n",
    "```{r map sign time cut 2 {{sig}},fig.height=3.5, fig.width=4.5, echo = FALSE}\n",
    "sign <- as.character('{{sig}}')",
    "signGenes <- allSign %>% dplyr::filter(signature == sign)",
    "pList <- NULL",
    "for(i in 1:length(unique(sce$time_plus_grp))){",
      "tiP <- unique(sce$time_plus_grp)[i]",
      "sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]",
      "sceSub <- sceSub[,sceSub$time_plus_grp == tiP]",
      "cntMat <- rowSums(
                t(as.matrix(sceSub@assays@data$logcounts)))/nrow(signGenes)",
      "sceSub$sign <- cntMat",
      "maxCM <- max(cntMat)",
      "minCM <- min(cntMat)",
      "maxCM <- 2",
      "pal = colorRampPalette(rev(brewer.pal(11, 'RdBu')))",
      "sc <- scale_colour_gradientn(colours = pal(100), limits=c(minCM,maxCM),
      na.value = pal(100)[100])",
      "p <- visGroup(sceSub, 'sign', dim_red = 'UMAP') +
      sc +
      guides(colour = guide_colourbar(title = '')) +
      ggtitle(paste0(sign, ' signature ', tiP)) +
      theme_classic() + 
      theme(axis.text = element_blank(),
          axis.ticks = element_blank()) +
      labs(x='Dimension 1', y='Dimension 2')",
      "pList[[i]] <- p}",
    "pList\n",
    "```\n",
    "\n"
)


plots_dpt <- lapply(sigNam, 
  function(sig) knitr::knit_expand(text = template_dpt)
)


```

`r knitr::knit(text = unlist(plots_dpt))`


### avg expression heatmap aross cluster
```{r avg heatmap funct}
avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(gsub("(^.*?_)","",
                                       colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=gsub("(_.*$)","",colnames(logNormExpresMa)))
  colnames(annotation_col)[1] <- "col1"
  annotation_col <- annotation_col %>%
    dplyr::mutate(cond = gsub("(^[0-9]_?)","",col1)) %>%
    dplyr::select(cond, celltype)
  rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colVecCond,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

```


```{r avg expression sign genes, fig.height=9, fig.width=7}

grpCnt <- allSign %>% group_by(signature) %>% summarise(cnt=n())
gapR <- data.frame(signature=unique(allSign$signature)) %>% 
  left_join(.,grpCnt, by="signature") %>% mutate(cumSum=cumsum(cnt)) 
ordVec <- levels(seurat)

pOut <- avgHeatmap(seurat = seurat, selGenes = allSign,
                  colVecIdent = colPal, 
                  ordVec=ordVec,
                  gapVecR=gapR$cumSum, gapVecC=NULL,cc=F,
                  cr=F, condCol=F)



```


### avg expression heatmap aross timepoints and condition

```{r avg expression sign genes across time plus grp, fig.height=9, fig.width=7}

Idents(seurat) <- seurat$time_plus_grp
grpCnt <- allSign %>% group_by(signature) %>% summarise(cnt=n())
gapR <- data.frame(signature=unique(allSign$signature)) %>% 
  left_join(.,grpCnt, by="signature") %>% mutate(cumSum=cumsum(cnt)) 
ordVec <- levels(seurat)[order(levels(seurat))]

pOut <- avgHeatmap(seurat = seurat, selGenes = allSign,
                  colVecIdent = colTime, 
                  ordVec=ordVec,
                  gapVecR=gapR$cumSum, gapVecC=NULL,cc=F,
                  cr=F, condCol=T, colVecCond = colGrp)



```

## expression of selected genes {.tabset}
```{r sel genes}

selGenes <- c("Grem1", "Grem2", "Bmp2","Bmp4", "Bmp7", "Bmpr1a", "Bmpr1b",
              "Bmpr2", "Bst1", "Clu", "Ncam1", "Ccl2", "Cxcl9", "Il11", "Timp1",
              "Plaur", "Hif1a", "Sod2", "Ccl19", "Cxcl13", "Il33", "Il6",
              "Vcam1", "Icam1", "H2-Aa", "Rosa26eyfp", "Ly6a")
selGenesLong <- data.frame(gene=rownames(seurat)) %>%
  mutate(short=gsub("^.*\\.", "", gene)) %>% filter(short %in% selGenes)

```


### sel Genes across all {.tabset}
```{r sel Genes across all}

template_fp <- c(
    "#### {{sel}}\n",
    "```{r sel Genes across all {{sel}},fig.height=3, fig.width=4, echo = FALSE}\n",
    "selGene <- as.character('{{sel}}')",
    "p <- FeaturePlot(seurat, reduction = 'umap',
      features = selGene,
      cols=c('lightgrey', 'darkred'),
              order = T)+
    theme(legend.position='right')",
    "p\n",
    "```\n",
    "\n"
)


plots_fp <- lapply(selGenesLong$gene, 
  function(sel) knitr::knit_expand(text = template_fp)
)

```

`r knitr::knit(text = unlist(plots_fp))`

### sel Genes split by grp {.tabset}
```{r el Genes split by grp}

template_fp <- c(
    "#### {{sel}}\n",
    "```{r sel Genes split by grp {{sel}},fig.height=3, fig.width=8, echo = FALSE}\n",
    "selGene <- as.character('{{sel}}')",
    "p <- FeaturePlot(seurat, reduction = 'umap',
      features = selGene,
      cols=c('lightgrey', 'darkred'),
      order = T,
      split.by = 'grp')+
    theme(legend.position='right')",
    "p\n",
    "```\n",
    "\n"
)


plots_fp <- lapply(selGenesLong$gene, 
  function(sel) knitr::knit_expand(text = template_fp)
)

```

`r knitr::knit(text = unlist(plots_fp))`

### sel Genes split by time {.tabset}
```{r sel Genes split by time}

template_fp <- c(
    "#### {{sel}}\n",
    "```{r sel Genes split by time {{sel}},fig.height=3, fig.width=12, echo = FALSE}\n",
    "selGene <- as.character('{{sel}}')",
    "p <- FeaturePlot(seurat, reduction = 'umap',
      features = selGene,
      cols=c('lightgrey', 'darkred'),
      order = T,
      split.by = 'time')+
    theme(legend.position='right')",
    "p\n",
    "```\n",
    "\n"
)


plots_fp <- lapply(selGenesLong$gene, 
  function(sel) knitr::knit_expand(text = template_fp)
)

```

`r knitr::knit(text = unlist(plots_fp))`


## session info
```{r session info}
sessionInfo()
date()
```




