---
title: "Merge samples total cells"
author: "Mechthild LÃ¼tge"
date: "24 July 2020"
output:
  html_document:
    self_contained: no
    code_folding: show
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float: true
    collapsed: no
    smooth_scroll: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dev = c("png", "pdf"))
set.seed(1000)
```

## load packages
```{r libs}
suppressPackageStartupMessages({
  library(SingleCellExperiment)
  library(tidyverse)
  library(Seurat)
  library(magrittr)
  library(dplyr)
  library(purrr)
  library(ggplot2)
  library(here)
  library(runSeurat3)
  library(ggsci)
  library(pheatmap)
  library(ggpubr)
})

```

## set dir
```{r set dir}
basedir <- here()
seurat <- readRDS(file = paste0(basedir,
                              "/data/MuHeart_totalCells_plusTreated_integrated",
                              "_seurat.rds"))
Idents(seurat) <- seurat$integrated_snn_res.0.4


## remove two contaminating clusters and rerun dim reductions
## cluster 18 (erythrocytes (Fech, Bpgm, Snca))
seurat <- subset(seurat, idents = c("18"), invert=T)

DefaultAssay(object = seurat) <- "integrated"
seurat <- RunPCA(object = seurat, npcs = 20, verbose = FALSE)
seurat <- RunTSNE(object = seurat, reduction = "pca", dims = 1:20)
seurat <- RunUMAP(object = seurat, reduction = "pca", dims = 1:20)
DefaultAssay(object = seurat) <- "RNA"


#saveRDS(seurat, file=paste0(basedir,
#                             "/data/MuHeart_totalCells_plusTreated_integrated_remEry",
#                             "_seurat.rds"))
seurat$age[which(seurat$treatment != "no")] <- "12wk"
```



## color vectors
```{r colVec}

colPal <- pal_igv()(length(levels(seurat)))
colGrp <- pal_jama()(length(unique(seurat$grp)))
colAge <- pal_uchicago()(length(unique(seurat$age)))
colStype <- pal_aaas()(length(unique(seurat$seqType)))
colDat <- c(pal_npg()(10),
            pal_futurama()(10))[1:(length(unique(seurat$dataset)))]
colTreat <- pal_jama()(length(unique(seurat$treatment)))

  
names(colPal) <- levels(seurat)
names(colGrp) <- unique(seurat$grp)
names(colAge) <- unique(seurat$age)
names(colStype) <- unique(seurat$seqType)
names(colDat) <- unique(seurat$dataset)
names(colTreat) <- unique(seurat$treatment)

```


## vis data {.tabset}
### clusters
```{r vis cluster}

DimPlot(seurat, reduction = "umap", cols=colPal)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```

### group
```{r vis grp}

DimPlot(seurat, reduction = "umap", group.by = "grp", cols=colGrp)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

```


### Sample
```{r vis sample, fig.height=4, fig.width=8}

DimPlot(seurat, reduction = "umap", group.by = "dataset", cols=colDat)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```


### Age
```{r vis age}

DimPlot(seurat, reduction = "umap", group.by = "age", cols=colAge)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```


### SeqType
```{r vis seqType}

DimPlot(seurat, reduction = "umap", group.by = "seqType", cols=colStype)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```

### Treatment
```{r vis treat}

DimPlot(seurat, reduction = "umap", group.by = "treatment", cols=colTreat)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```



## assign labels {.tabset}
```{r assign labels}

## -------------------------------------------------------------------------- ##
## cluster 9 re-embedding (Tcells + NKcells mixed)
seuratSub <- subset(seurat, integrated_snn_res.0.25 %in% c("2", "6", "9", "7", "13"))
DefaultAssay(object = seuratSub) <- "integrated"
seuratSub <- ScaleData(object = seuratSub, verbose = FALSE,
                        features = rownames(seuratSub))
seuratSub <- RunPCA(object = seuratSub, npcs = 20, verbose = FALSE)
seuratSub <- RunTSNE(object = seuratSub, reduction = "pca", dims = 1:20)
seuratSub <- RunUMAP(object = seuratSub, reduction = "pca", dims = 1:20)

seuratSub <- FindNeighbors(object = seuratSub, reduction = "pca", dims = 1:20)
res <- c(0.1,0.25)
for(i in 1:length(res)){
  seuratSub <- FindClusters(object = seuratSub, resolution = res[i],
                             seuratSub = 1234)
}

Tcells <- colnames(seuratSub)[seuratSub$integrated_snn_res.0.25 %in% c("5", "6")]
NKcells <- colnames(seuratSub)[seuratSub$integrated_snn_res.0.25 %in% c("8")]
Neutro <- colnames(seuratSub)[seuratSub$integrated_snn_res.0.25 %in% c("9")]
Eosino <- colnames(seuratSub)[seuratSub$integrated_snn_res.0.25 %in% c("12")]
pDCs <- colnames(seuratSub)[seuratSub$integrated_snn_res.0.25 %in% c("11")]
Macro <- colnames(seuratSub)[seuratSub$integrated_snn_res.0.25 %in% c("0", "3",
                                                                      "1", "10", "7")]
infMono <- colnames(seuratSub)[seuratSub$integrated_snn_res.0.25 %in% c("2")]
DCs <- colnames(seuratSub)[seuratSub$integrated_snn_res.0.25 %in% c("4")]


## -------------------------------------------------------------------------- ##


seurat$label <- "other"
#seurat$label[which(seurat$integrated_snn_res.0.4 %in% c("12", "4"))] <- "Macrophages"
seurat$label[which(seurat$integrated_snn_res.0.25 %in% c("11"))] <- "Bcells"
#seurat$label[which(seurat$integrated_snn_res.0.4 %in% c("6"))] <- "Tcells"
#seurat$label[which(seurat$integrated_snn_res.0.25 %in% c("13"))] <- "Neutrophils"
#seurat$label[which(seurat$integrated_snn_res.0.4 %in% c("21"))] <- "pDCs"
seurat$label[which(seurat$integrated_snn_res.0.25 %in% c("12"))] <- "proliferating"
seurat$label[which(seurat$integrated_snn_res.0.25 %in% c("0", "4", "16", "10"))] <-"Fibroblasts"
seurat$label[which(seurat$integrated_snn_res.0.25 %in% c("3", "17"))] <- "Cardiomyocytes"
seurat$label[which(seurat$integrated_snn_res.0.25 %in% c("1"))] <- "Endothelial"
seurat$label[which(seurat$integrated_snn_res.0.25 %in% c("5"))] <- "Perivascular"
seurat$label[which(seurat$integrated_snn_res.0.25 %in% c("8"))] <- "endocardialEndothelial"
seurat$label[which(seurat$integrated_snn_res.0.25 %in% c("15"))] <- "GlialCells"
#seurat$label[which(seurat$integrated_snn_res.0.4 %in% c("7"))] <- "InfMonos"
seurat$label[which(colnames(seurat) %in% NKcells)] <- "NKcells"
seurat$label[which(colnames(seurat) %in% Tcells)] <- "Tcells"
seurat$label[which(colnames(seurat) %in% Eosino)] <- "Eosinophils"
seurat$label[which(colnames(seurat) %in% Neutro)] <- "Neutrophils"
seurat$label[which(colnames(seurat) %in% pDCs)] <- "pDCs"
seurat$label[which(colnames(seurat) %in% DCs)] <- "DCs"
seurat$label[which(colnames(seurat) %in% Macro)] <- "Macrophages"
seurat$label[which(colnames(seurat) %in% infMono)] <- "InfMonos"

colLab <- pal_igv()(length(unique(seurat$label)))
names(colLab) <- unique(seurat$label)
```


### label
```{r vis label}

DimPlot(seurat, reduction = "umap", group.by = "label", cols=colLab)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```


### label split by seqType
```{r vis label split seq, fig.height=3.5, fig.width=7}

DimPlot(seurat, reduction = "umap", group.by = "label", cols=colLab,
        split.by = "seqType")+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```

### label split by grp
```{r vis label split grp, fig.height=3.5, fig.width=7}

DimPlot(seurat, reduction = "umap", group.by = "label", cols=colLab,
        split.by = "grp")+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```

### label split by treat
```{r vis label split treat, fig.height=3.5, fig.width=7}

DimPlot(seurat, reduction = "umap", group.by = "label", cols=colLab,
        split.by = "treatment")+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```



### cnt Tab
```{r cnts par lab per seqType}

table(seurat$label, seurat$seqType)
table(seurat$label, seurat$grp)
table(seurat$label, seurat$treatment)
```
## vis BMPs all incl treated {.tabset}
### Bmp2
```{r vis Bmp2 all}
p <- FeaturePlot(seurat, reduction = "umap", 
            features = "ENSMUSG00000027358.Bmp2",
            cols=c("lightgrey", "darkred"),
            order = T)+
  theme(legend.position="right")
p

```

### Bmp4
```{r vis Bmp4 all}
p <- FeaturePlot(seurat, reduction = "umap", 
            features = "ENSMUSG00000021835.Bmp4",
            cols=c("lightgrey", "darkred"),
            order = T)+
  theme(legend.position="right")
p

```

### Bmpr1a
```{r vis Bmpr1a all}
p <- FeaturePlot(seurat, reduction = "umap", 
            features = "ENSMUSG00000021796.Bmpr1a",
            cols=c("lightgrey", "darkred"),
            order = T)+
  theme(legend.position="right")
p

```

### Bmpr2
```{r vis Bmpr2 all}
p <- FeaturePlot(seurat, reduction = "umap", 
            features = "ENSMUSG00000067336.Bmpr2",
            cols=c("lightgrey", "darkred"),
            order = T)+
  theme(legend.position="right")
p

```

## save integrated objects all
```{r save int all}
saveRDS(seurat, file = paste0(basedir,
                      "/data/MuHeart_totalCellsPlusTreated_integratedLabeled", 
                      "_seurat.rds"))


```


## only untreated
```{r only untreated}

seurat <- subset(seurat, treatment == "no")

```

## vis data {.tabset}
### label
```{r vis label wo treat}

DimPlot(seurat, reduction = "umap", group.by = "label", cols=colLab)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```


### label split by seqType
```{r vis label split seq wo treat, fig.height=3.5, fig.width=7}

DimPlot(seurat, reduction = "umap", group.by = "label", cols=colLab,
        split.by = "seqType")+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```

### label split by grp
```{r vis label split grp wo treat, fig.height=3.5, fig.width=7}

DimPlot(seurat, reduction = "umap", group.by = "label", cols=colLab,
        split.by = "grp")+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```


## cw DE genes {.tabset} 

### 4 weeks

```{r cw DE genes 4wk}

seuratSub <- subset(seurat, age == "4wk")
Idents(seuratSub) <- seuratSub$grp
grpVec <- unique(seuratSub$label)

clustDE <- lapply(grpVec, function(grp){
  grpSub <- unique(seuratSub$label)[which(
    unique(seuratSub$label)==grp)]
  seuratSub2 <- subset(seuratSub, label == grpSub)
  DEgenes <-FindAllMarkers(seuratSub2, only.pos=T, logfc.threshold = 0.25,
                           min.pct = 0.1)
  if(nrow(DEgenes)>1){
    DEgenes <- DEgenes %>% filter(p_val_adj<0.01) %>%
      mutate(group=paste0(grp, "_", cluster))
    }
})

names(clustDE) <- grpVec

clustDE_Dat4 <- data.frame(do.call("rbind", clustDE))
```


### 8 weeks

```{r cw DE genes 8wk}

seuratSub <- subset(seurat, age == "8wk")
Idents(seuratSub) <- seuratSub$grp
grpVec <- unique(seuratSub$label)

clustDE <- lapply(grpVec, function(grp){
  grpSub <- unique(seuratSub$label)[which(
    unique(seuratSub$label)==grp)]
  seuratSub2 <- subset(seuratSub, label == grpSub)
  DEgenes <-FindAllMarkers(seuratSub2, only.pos=T, logfc.threshold = 0.25,
                           min.pct = 0.1)
  if(nrow(DEgenes)>1){
    DEgenes <- DEgenes %>% filter(p_val_adj<0.01) %>%
      mutate(group=paste0(grp, "_", cluster))
    }
})

names(clustDE) <- grpVec


clustDE_Dat8 <- data.frame(do.call("rbind", clustDE))
```


## vis BMPs {.tabset}
### Bmp2
```{r vis Bmp2 wo treat}
p <- FeaturePlot(seurat, reduction = "umap", 
            features = "ENSMUSG00000027358.Bmp2",
            cols=c("lightgrey", "darkred"),
            order = T)+
  theme(legend.position="right")
p

```

### Bmp4
```{r vis Bmp4 wo treat}
p <- FeaturePlot(seurat, reduction = "umap", 
            features = "ENSMUSG00000021835.Bmp4",
            cols=c("lightgrey", "darkred"),
            order = T)+
  theme(legend.position="right")
p

```

### Bmpr1a
```{r vis Bmpr1a wo treat}
p <- FeaturePlot(seurat, reduction = "umap", 
            features = "ENSMUSG00000021796.Bmpr1a",
            cols=c("lightgrey", "darkred"),
            order = T)+
  theme(legend.position="right")
p

```

### Bmpr2
```{r vis Bmpr2 wo treat}
p <- FeaturePlot(seurat, reduction = "umap", 
            features = "ENSMUSG00000067336.Bmpr2",
            cols=c("lightgrey", "darkred"),
            order = T)+
  theme(legend.position="right")
p

```


## save integrated objects
```{r save int wo treat}
saveRDS(seurat, file = paste0(basedir,
                      "/data/MuHeart_totalCells_integratedLabeled_seurat.rds"))

write.table(clustDE_Dat4,
            file=paste0(basedir,
              "/data/MuHeart_totalCells_integratedLabeled_4wks_cwDEGenes.txt"),
            row.names = FALSE, col.names = TRUE, quote = FALSE, sep = "\t")

write.table(clustDE_Dat8,
            file=paste0(basedir,
              "/data/MuHeart_totalCells_integratedLabeled_8wks_cwDEGenes.txt"),
            row.names = FALSE, col.names = TRUE, quote = FALSE, sep = "\t")

```



## session info
```{r session info}
sessionInfo()
date()
```




