---
title: "Diffusionmap Fibroblasts 14D102 plus isotype"
author: "Mechthild LÃ¼tge"
date: "24 July 2020"
output:
  html_document:
    self_contained: no
    code_folding: show
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float: true
    collapsed: no
    smooth_scroll: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dev = c("png", "pdf"))
set.seed(1000)
```

## load packages
```{r libs}
suppressPackageStartupMessages({
  library(SingleCellExperiment)
  library(tidyverse)
  library(Seurat)
  library(magrittr)
  library(dplyr)
  library(purrr)
  library(ggplot2)
  library(here)
  library(runSeurat3)
  library(ggsci)
  library(pheatmap)
  library(ggpubr)
  library(destiny)
  library(CellMixS)
  library(DelayedArray)
  library(DelayedMatrixStats)
  library(RColorBrewer)
})

```



## sign plot funct
```{r funct sign plot}
## adapted from CellMixS
visGroup_adapt <- function (sce,group,dim_red = "TSNE",col_group=pal_nejm()(8)) 
{
    if (!is(sce, "SingleCellExperiment")) {
        stop("Error:'sce' must be a 'SingleCellExperiment' object.")
    }
    if (!group %in% names(colData(sce))) {
        stop("Error: 'group' variable must be in 'colData(sce)'")
    }
    cell_names <- colnames(sce)
    if (!dim_red %in% "TSNE") {
        if (!dim_red %in% reducedDimNames(sce)) {
            stop("Please provide a dim_red method listed in reducedDims of sce")
        }
        red_dim <- as.data.frame(reducedDim(sce, dim_red))
    }
    else {
        if (!"TSNE" %in% reducedDimNames(sce)) {
            if ("logcounts" %in% names(assays(sce))) {
                sce <- runTSNE(sce)
            }
            else {
                sce <- runTSNE(sce, exprs_values = "counts")
            }
        }
        red_dim <- as.data.frame(reducedDim(sce, "TSNE"))
    }
    colnames(red_dim) <- c("red_dim1", "red_dim2")
    df <- data.frame(sample_id = cell_names, group_var = colData(sce)[, 
        group], red_Dim1 = red_dim$red_dim1, red_Dim2 = red_dim$red_dim2)
    t <- ggplot(BuenColors::shuf(df), aes_string(x = "red_Dim1",
                                                 y = "red_Dim2")) + 
        xlab(paste0(dim_red, "_1")) + ylab(paste0(dim_red, "_2")) + 
        theme_void() + theme(aspect.ratio = 1,
                             panel.grid.minor = element_blank(), 
        panel.grid.major = element_line(color = "grey", size = 0.3))
    t_group <- t + geom_point(size = 1.5, alpha = 0.8,
                              aes_string(color = "group_var")) + 
        guides(color = guide_legend(override.aes = list(size = 1), 
            title = group)) + ggtitle(group)
    if (is.numeric(df$group_var)) {
        t_group <- t_group + scale_color_viridis(option = "D")
    }
    else {
        t_group <- t_group + scale_color_manual(values = col_group)
    }
    t_group
}



```


## set dir and subset data on Fibroblasts
```{r set dir}
basedir <- here()
seurat <- readRDS(file = paste0(basedir,
                      "/data/MuHeart_totalCellsPlusTreated_integratedLabeled", 
                      "_seurat.rds"))
seurat$age[which(seurat$treatment != "no")] <- "12wk"
dim(seurat)
seurat <- subset(seurat, label == "Fibroblasts")
seurat <- subset(seurat, treatment != "no")
dim(seurat)
table(seurat$treatment)
table(seurat$seqType, seurat$treatment)

seurat <- subset(seurat, seqType == "sc")
seurat <- rerunSeurat3(seurat)

```



## color vectors
```{r colVec}

colPal <- pal_igv()(length(levels(seurat)))
colGrp <- pal_jama()(length(unique(seurat$grp)))
colAge <- pal_uchicago()(length(unique(seurat$age)))
colStype <- pal_aaas()(length(unique(seurat$seqType)))
colDat <- c(pal_npg()(10),
            pal_futurama()(10))[1:(length(unique(seurat$dataset)))]
colTreat <- pal_jama()(length(unique(seurat$treatment)))

names(colPal) <- levels(seurat)
names(colGrp) <- unique(seurat$grp)
names(colAge) <- unique(seurat$age)
names(colStype) <- unique(seurat$seqType)
names(colDat) <- unique(seurat$dataset)
names(colTreat) <- unique(seurat$treatment)

colLab <- c("#5050FF", "#CE3D32", "#749B58", "#F0E685",
            "#466983", "#BA6388", "#5DB1DD", "#802268",
            "#6BD76B", "#D595A7", "#924822", "#837B8D",
            "#C75127", "#D58F5C", "#7A65A5", "#E4AF69")

names(colLab) <- c("InfMonos", "Tcells", "Endothelial", "Macrophages",
                   "Fibroblasts", "DCs", "NKcells", "Perivascular",
                   "Neutrophils", "Bcells", "Cardiomyocytes", "proliferating",
                   "pDCs", "endocardialEndothelial", "Eosinophils",
                   "GlialCells")
```

## vis data {.tabset}


### Sample
```{r vis sample, fig.height=3.5, fig.width=6}

DimPlot(seurat, reduction = "umap", group.by = "dataset", cols=colDat)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```

### SeqType
```{r vis seqType}

DimPlot(seurat, reduction = "umap", group.by = "seqType", cols=colStype)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

DimPlot(seurat, reduction = "umap", group.by = "seqType", cols=colStype)+
  theme_void() 
```

### Treatment
```{r vis treat}

DimPlot(seurat, reduction = "umap", group.by = "treatment", cols=colTreat)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

DimPlot(seurat, reduction = "umap", group.by = "treatment", cols=colTreat)+
  theme_void() 

```

### label split by treat
```{r vis label split treat, fig.height=3.5, fig.width=7}

DimPlot(seurat, reduction = "umap", group.by = "label", cols=colLab,
        split.by = "treatment")+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

DimPlot(seurat, reduction = "umap", group.by = "label", cols=colLab,
        split.by = "treatment")+
  theme_void() 


DimPlot(seurat, reduction = "umap", group.by = "RNA_snn_res.0.25", cols=colPal)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

```


## gene signatures {.tabset}
```{r define gene signatures}

c0Sig <- data.frame(gene=c("Cxcl9", "Cxcl10", "Ccl2", "Cxcl5", "Ccl19",
                           "Cxcl12", "Cxcl1")) %>%
  mutate(signature="CellRecruitment")

c1Sig <- data.frame(gene=c("H2-D1", "H2-K1","B2m","H2-Ab1","H2-Q7","H2-Aa",
                           "Tap1")) %>% 
  mutate(signature="AntigenPresentation")

c5Sig <- data.frame(gene=c("Ly6a","Bst2","Vcam1","Icam1","Ncam1","C3",
                           "Nfkbia")) %>%
  mutate(signature="ActivationInteraction")

c7Sig <- data.frame(gene=c("Timp1","Sod2","Il33","Hif1a","Plaur","Cxcl16")) %>%
  mutate(signature="DamageRemodeling")

c10Sig <- data.frame(gene=c("Nr4a1","Pi16","Pdpn","Cd34","Pdgfra","Col1a1")) %>%
  mutate(signature="FBidentity")

ARsig <- data.frame(gene=c("Col8a1","Col4a4","Col4a1","Col4a5","Col5a3")) %>%
  mutate(signature="TissueStructure")

IIsig <- data.frame(gene=c("Bmp4","Id1","Tcf4","Jun","Tgfb1","Ccn1")) %>%
  mutate(signature="TissueHomeostasis")

allGenes <- data.frame(geneID = rownames(seurat)) %>%
  mutate(gene=gsub("^.*\\.","", geneID))
allSign <- rbind(c0Sig, c1Sig, c5Sig, c7Sig, c10Sig, ARsig, IIsig) %>%
  left_join(., allGenes, by="gene")
```


## run Diffusionmap
```{r run DM}

sce <- as.SingleCellExperiment(seurat)

## from scater: subset to 500 most variable genes
dmMat <- sce@assays@data@listData$logcounts
rv <- rowVars(DelayedArray(dmMat))
o <- order(rv, decreasing = TRUE)
subset_row <- head(o, 200)
dmMat <- dmMat[subset_row,, drop = FALSE]
rv <- rv[subset_row]
dmMat <- t(dmMat)
dmMat <- as.matrix(dmMat)

dm <- destiny::DiffusionMap(dmMat, verbose = TRUE)
reducedDim(sce, 'DiffusionMap') <- dm@eigenvectors[, 1:2, drop = FALSE]

```

## vis DM
```{r vis DM}

p <- visGroup_adapt(sce, 'treatment', dim_red = 'DiffusionMap') +
    scale_colour_manual(values = colTreat) +
    theme_classic() + 
    theme(axis.text = element_blank(),
          axis.ticks = element_blank()) +
    labs(x='Dimension 1', y='Dimension 2')
p

p2 <- p + facet_wrap(~ group_var)
p2


p <- visGroup_adapt(sce, 'RNA_snn_res.0.25', dim_red = 'DiffusionMap') +
    scale_colour_manual(values = colPal) +
    theme_classic() + 
    theme(axis.text = element_blank(),
          axis.ticks = element_blank()) +
    labs(x='Dimension 1', y='Dimension 2')
p


```


## plot signatures DM {.tabset}
```{r map sign DM}

sigNam <- unique(allSign$signature)

template_dp <- c(
    "### {{sig}}\n",
    "```{r map sign DM cut 2 {{sig}},fig.height=3.5, fig.width=4.5, echo = FALSE}\n",
    "sign <- as.character('{{sig}}')",
    "signGenes <- allSign %>% dplyr::filter(signature == sign)",
    "sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]",
    "cntMat <- rowSums(
                t(as.matrix(sceSub@assays@data$logcounts)))/nrow(signGenes)",
    "sceSub$sign <- cntMat",
    "maxCM <- max(cntMat)",
    "minCM <- min(cntMat)",
    "maxCM <- 2",
    "pal = colorRampPalette(rev(brewer.pal(11, 'RdBu')))",
    "sc <- scale_colour_gradientn(colours = pal(100), limits=c(minCM,maxCM),
    na.value = pal(100)[100])",
    "p <- visGroup(sceSub, 'sign', dim_red = 'DiffusionMap') +
    sc +
    guides(colour = guide_colourbar(title = '')) +
    ggtitle(paste0(sign, ' signature')) +
    theme_classic() + 
    theme(axis.text = element_blank(),
          axis.ticks = element_blank()) +
    labs(x='Dimension 1', y='Dimension 2')",
    "p\n",
    "```\n",
    "\n"
)


plots_dpt <- lapply(sigNam, 
  function(sig) knitr::knit_expand(text = template_dp)
)


```

`r knitr::knit(text = unlist(plots_dpt))`


## map signature on DM for each treatment {.tabset}
```{r map sign DM per treat cut 2}

template_dpt <- c(
    "### {{sig}}\n",
    "```{r map sign DM per treat cut 2 {{sig}},fig.height=3.5,fig.width=4.5, echo = FALSE}\n",
    "sign <- as.character('{{sig}}')",
    "signGenes <- allSign %>% dplyr::filter(signature == sign)",
    "pList <- NULL",
    "for(i in 1:length(unique(sce$treatment))){",
      "tiP <- unique(sce$treatment)[i]",
      "sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]",
      "sceSub <- sceSub[,sceSub$treatment == tiP]",
      "cntMat <- rowSums(
                t(as.matrix(sceSub@assays@data$logcounts)))/nrow(signGenes)",
      "sceSub$sign <- cntMat",
      "maxCM <- max(cntMat)",
      "minCM <- min(cntMat)",
      "maxCM <- 2",
      "pal = colorRampPalette(rev(brewer.pal(11, 'RdBu')))",
      "sc <- scale_colour_gradientn(colours = pal(100), limits=c(minCM,maxCM),
      na.value = pal(100)[100])",
      "p <- visGroup(sceSub, 'sign', dim_red = 'DiffusionMap') +
      sc +
      guides(colour = guide_colourbar(title = '')) +
      ggtitle(paste0(sign, ' signature ', tiP)) +
      theme_classic() + 
      theme(axis.text = element_blank(),
          axis.ticks = element_blank()) +
      labs(x='Dimension 1', y='Dimension 2')",
      "pList[[i]] <- p}",
    "pList\n",
    "```\n",
    "\n"
)


plots_dpt <- lapply(sigNam, 
  function(sig) knitr::knit_expand(text = template_dpt)
)


```

`r knitr::knit(text = unlist(plots_dpt))`

## map signature on DM for each treatment {.tabset}
```{r map sign DM per treat cut 2.5}

template_dpt <- c(
    "### {{sig}}\n",
    "```{r map sign DM per treat cut 2.5 {{sig}},fig.height=3.5,fig.width=4.5, echo = FALSE}\n",
    "sign <- as.character('{{sig}}')",
    "signGenes <- allSign %>% dplyr::filter(signature == sign)",
    "pList <- NULL",
    "for(i in 1:length(unique(sce$treatment))){",
      "tiP <- unique(sce$treatment)[i]",
      "sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]",
      "sceSub <- sceSub[,sceSub$treatment == tiP]",
      "cntMat <- rowSums(
                t(as.matrix(sceSub@assays@data$logcounts)))/nrow(signGenes)",
      "sceSub$sign <- cntMat",
      "maxCM <- max(cntMat)",
      "minCM <- min(cntMat)",
      "maxCM <- 2.5",
      "pal = colorRampPalette(rev(brewer.pal(11, 'RdBu')))",
      "sc <- scale_colour_gradientn(colours = pal(100), limits=c(minCM,maxCM),
      na.value = pal(100)[100])",
      "p <- visGroup(sceSub, 'sign', dim_red = 'DiffusionMap') +
      sc +
      guides(colour = guide_colourbar(title = '')) +
      ggtitle(paste0(sign, ' signature ', tiP)) +
      theme_classic() + 
      theme(axis.text = element_blank(),
          axis.ticks = element_blank()) +
      labs(x='Dimension 1', y='Dimension 2')",
      "pList[[i]] <- p}",
    "pList\n",
    "```\n",
    "\n"
)


plots_dpt <- lapply(sigNam, 
  function(sig) knitr::knit_expand(text = template_dpt)
)


```

`r knitr::knit(text = unlist(plots_dpt))`



## map signature on UMAP for each treatment {.tabset}
```{r map sign UMAP per treat cut 2}

template_dpt <- c(
    "### {{sig}}\n",
    "```{r map sign UMAP per treat cut 2 {{sig}},fig.height=3,fig.width=5, echo = FALSE}\n",
    "sign <- as.character('{{sig}}')",
    "signGenes <- allSign %>% dplyr::filter(signature == sign)",
    "pList <- NULL",
    "for(i in 1:length(unique(sce$treatment))){",
      "tiP <- unique(sce$treatment)[i]",
      "sceSub <- sce[which(rownames(sce) %in% signGenes$geneID),]",
      "sceSub <- sceSub[,sceSub$treatment == tiP]",
      "cntMat <- rowSums(
                t(as.matrix(sceSub@assays@data$logcounts)))/nrow(signGenes)",
      "sceSub$sign <- cntMat",
      "maxCM <- max(cntMat)",
      "minCM <- min(cntMat)",
      "maxCM <- 2",
      "pal = colorRampPalette(rev(brewer.pal(11, 'RdBu')))",
      "sc <- scale_colour_gradientn(colours = pal(100), limits=c(minCM,maxCM),
      na.value = pal(100)[100])",
      "p <- visGroup(sceSub, 'sign', dim_red = 'UMAP') +
      sc +
      guides(colour = guide_colourbar(title = '')) +
      ggtitle(paste0(sign, ' signature ', tiP)) +
      theme_classic() + 
      theme(axis.text = element_blank(),
          axis.ticks = element_blank()) +
      labs(x='Dimension 1', y='Dimension 2')",
      "pList[[i]] <- p}",
    "pList\n",
    "```\n",
    "\n"
)


plots_dpt <- lapply(sigNam, 
  function(sig) knitr::knit_expand(text = template_dpt)
)


```

`r knitr::knit(text = unlist(plots_dpt))`


## session info
```{r session info}
sessionInfo()
date()
```




