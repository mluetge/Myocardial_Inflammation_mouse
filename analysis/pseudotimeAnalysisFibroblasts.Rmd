---
title: "pseudotime analysis"
author: "Mechthild LÃ¼tge"
date: "6 Oct 2020"
output:
  html_document:
    self_contained: no
    code_folding: show
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float: true
    collapsed: no
    smooth_scroll: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dev = c("png", "pdf"))
set.seed(1000)
```

## load packages
```{r libs}
suppressPackageStartupMessages({
  library(tidyverse)
  library(Seurat)
  library(magrittr)
  library(dplyr)
  library(purrr)
  library(ggplot2)
  library(here)
  library(runSeurat3)
  library(slingshot)
  library(SingleCellExperiment)
  library(scales)
  library(grDevices)
  library(RColorBrewer)
  library(pheatmap)
  library(ggsci)
  library(scran)
  library(scater)
})

```

## set dir
```{r set dir}
basedir <- here()
seurat <- readRDS(file = paste0(basedir, 
                                "/data/TCRM_all10samplesMerged_seurat.rds"))

seurat$time_plus_grp <- paste0(seurat$time, "_", seurat$grp)
```

## color vectors
```{r colVec}

colPal <- pal_igv()(length(levels(seurat)))
colGrp <- pal_jama()(length(unique(seurat$grp)))
colSmp <- c(pal_uchicago()(8), pal_npg()(8))[1:length(unique(seurat$dataset))]
colTime <- pal_npg()(length(unique(seurat$time)))

names(colPal) <- levels(seurat)
names(colGrp) <- unique(seurat$grp)
names(colSmp) <- unique(seurat$dataset)
names(colTime) <- unique(seurat$time)

```

## vis data {.tabset}
### clusters
```{r vis cluster}
DimPlot(seurat, reduction = "umap", cols=colPal)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```

### group
```{r vis grp}

DimPlot(seurat, reduction = "umap", group.by = "grp", cols=colGrp)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

```

### timepoint
```{r vis timepoint}

DimPlot(seurat, reduction = "umap", group.by = "time", cols=colTime)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```

### clustering res 0.25
```{r vis cluster res 0.25}

DimPlot(seurat, reduction = "umap", group.by = "RNA_snn_res.0.4", cols=colPal)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```




## run slingshot {.tabset}
```{r slinshot}

sce <- as.SingleCellExperiment(seurat)
sce <- slingshot(sce, clusterLabels = 'RNA_snn_res.0.4', reducedDim = 'UMAP',
                 approx_points = 100, stretch = 0,
                 thresh = 0.001, omega = 10, extend = "n",
                 start.clus = "7")

colPalDat <- data.frame(Color=colPal, cl=names(colPal))
colDat <- data.frame(cl=sce$seurat_clusters) %>% 
  left_join(., colPalDat, by="cl")


```


### plot lineages
```{r plot lineages}

plot(reducedDims(sce)$UMAP, col = colDat$Color, pch = 16, cex = 0.5)
lines(SlingshotDataSet(sce), lwd = 2, type = 'lineages', col = 'black')

```


### plot curve col cluster
```{r slingshot curve col cluster}

plot(reducedDims(sce)$UMAP, col = colDat$Color, pch = 16, cex = 0.5)
lines(SlingshotDataSet(sce), lwd = 2, col = 'black')


```

### plot curve col pseudotime
```{r slingshot curve col pseudotime}

colors <- colorRampPalette(brewer.pal(8,'OrRd'))(100)
plotcol <- colors[cut(sce$slingPseudotime_1, breaks=100)]
plotcol2 <- colors[cut(sce$slingPseudotime_2, breaks=100)]
plotcol3 <- colors[cut(sce$slingPseudotime_3, breaks=100)]
plotcol4 <- colors[cut(sce$slingPseudotime_4, breaks=100)]

plotColAll <- plotcol
plotColAll[which(is.na(plotColAll))] <- plotcol2[which(is.na(plotColAll))]
plotColAll[which(is.na(plotColAll))] <- plotcol3[which(is.na(plotColAll))]
plotColAll[which(is.na(plotColAll))] <- plotcol4[which(is.na(plotColAll))]

plot(reducedDims(sce)$UMAP, col = plotColAll, pch = 16, cex = 0.3)
lines(SlingshotDataSet(sce), lwd = 2, col = 'black')

```

## save sce object with pseudotime ordering
```{r save sce}
saveRDS(sce, file= paste0(basedir, "/data/TCRM_all10samplesMerged_sce.rds"))
#sce <- readRDS(paste0(basedir, "/data/TCRM_all10samplesMerged_sce.rds"))

```


```{r eval=FALSE, include=FALSE}
pseudo <- TSCAN::testPseudotime(sce, pseudotime=sce$slingPseudotime_1)
pseudoDat <- data.frame(pseudo[which(pseudo$FDR<0.05),]) %>%
  dplyr::mutate(absLogFC = abs(logFC)) %>% 
  slice_max(., absLogFC, n=50) %>% 
  rownames_to_column(var="gene") %>% 
  arrange(desc(absLogFC))

sptAll <- unique(names(colData(sce))[grepl("slingPseudotime_*",
                                           names(colData(sce)))])

p <- lapply(sptAll, function(spt){
  pseudo <- TSCAN::testPseudotime(sce, pseudotime=colData(sce)[,spt])
  pseudoDat <- data.frame(pseudo[which(pseudo$FDR<0.05),]) %>%
    dplyr::mutate(absLogFC = abs(logFC)) %>% 
    slice_max(., absLogFC, n=50) %>% 
    rownames_to_column(var="gene") %>% 
    arrange(desc(absLogFC))
  on.spt.path <- !is.na(colData(sce)[,spt])
  plotHeatmap(sce[,on.first.path], order_columns_by=spt, 
    colour_columns_by="seurat_clusters", features=pseudoDat$gene, 
    color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
    center=TRUE)
})


```


### sel Genes across all {.tabset}
```{r change along pst}

sptAll <- unique(names(colData(sce))[grepl("slingPseudotime_*",
                                           names(colData(sce)))])

template_fp <- c(
    "#### {{spt}}\n",
    "```{r change along pst {{spt}},fig.height=10, fig.width=7,echo = FALSE}\n",
    "pseudo <- TSCAN::testPseudotime(sce,
    pseudotime=colData(sce)[,as.character('{{spt}}')])",
    "pseudoDat <- data.frame(pseudo[which(pseudo$FDR<0.05),]) %>%
    dplyr::mutate(absLogFC = abs(logFC)) %>% 
    slice_max(., absLogFC, n=50) %>% 
    rownames_to_column(var='gene') %>% 
    arrange(desc(absLogFC))",
    "on.spt.path <- !is.na(colData(sce)[,as.character('{{spt}}')])",
    "plot(reducedDims(sce[,on.spt.path])$UMAP, col = plotColAll, pch = 16, cex = 0.3)",
    "lines(SlingshotDataSet(sce[,on.spt.path]), lwd = 2, col = 'black')",
    "p <- plotHeatmap(sce[,on.spt.path],
     order_columns_by=as.character('{{spt}}'), 
     colour_columns_by='seurat_clusters', features=pseudoDat$gene, 
     color = colorRampPalette(c('#2166AC', '#F7F7F7', '#B2182B'))(50),
     center=TRUE)",
    "p\n",
    "```\n",
    "\n"
)


plots_fp <- lapply(sptAll, 
  function(spt) knitr::knit_expand(text = template_fp)
)

```

`r knitr::knit(text = unlist(plots_fp))`


## session info
```{r session info}
sessionInfo()
date()
```

