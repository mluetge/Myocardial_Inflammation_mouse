---
title: "Merge CD45+ cells"
author: "Mechthild LÃ¼tge"
date: "29 April 2021"
output:
  html_document:
    self_contained: no
    code_folding: show
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float: true
    collapsed: no
    smooth_scroll: yes
---

```{r setup, include=FALSE}
options(width = 100)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dev = c("png", "pdf"))
seed <- 1234
```


## load packages
```{r libs}
suppressPackageStartupMessages({
  library(clusterProfiler)
  library(org.Mm.eg.db)
  library(DOSE)
  library(enrichplot)
  library(msigdbr)
  library(SingleCellExperiment)
  library(tidyverse)
  library(Seurat)
  library(magrittr)
  library(dplyr)
  library(purrr)
  library(ggplot2)
  library(here)
  library(runSeurat3)
  library(ggsci)
  library(ggpubr)
  library(pheatmap)
})

```

## set dir
```{r set dir}
basedir <- here()
metaDat <- read_tsv(paste0(basedir, "/metadata_lymphcytes.txt"), col_names = T)

```


## load and assign samples
```{r load plus assign samples}

assignSamples <- function(smpNam, basedirSmp, smpGrp, smpBatch){
  smpNamFull <- list.files(path = paste0(basedirSmp, "/data/"),
				 pattern = paste0(smpNam, ".*_seurat.rds"))
  seuratSmp <- readRDS(paste0(basedirSmp, "/data/", smpNamFull))
  seuratSmp$grp <- smpGrp
  seuratSmp$batch <- smpBatch
  return(seuratSmp)
}

####################################################################

for(i in 1:length(metaDat$Sample)){
  seuratX <- assignSamples(smpNam = metaDat$Sample[i],
                           basedirSmp = basedir,
                           smpGrp = metaDat$group[i],
                           smpBatch = metaDat$batch[i])
  if(exists("seurat")){
    seurat <- merge(x = seurat, y = seuratX, project = "TCRMxCD45")
  }else{
    seurat <- seuratX
  }
}

remove(seuratX)

```


## remove contaminating cells
```{r remove cont cells}

seurat <- subset(seurat, subset = ENSMUSG00000001506.Col1a1 == 0)
seurat <- subset(seurat, subset = ENSMUSG00000029231.Pdgfra == 0)
seurat <- subset(seurat, subset = ENSMUSG00000024620.Pdgfrb == 0)
seurat <- subset(seurat, subset = ENSMUSG00000020717.Pecam1 == 0)

```


## run clustering and DR and remove contaminating cells
```{r clustering and DR}

seurat <- rerunSeurat3(seurat, res=c(0.6, 0.4, 0.25))
dim(seurat)
seurat$cluster_plus_cond <- paste0(seurat$seurat_clusters, "_", seurat$grp)


## remove contaminating endothelial cells
seurat <- subset(seurat, idents = "13", invert=T)
seurat <- RunPCA(object = seurat, npcs = 30, verbose = FALSE)
seurat <- RunTSNE(object = seurat, reduction = "pca", dims = 1:20)
seurat <- RunUMAP(object = seurat, reduction = "pca", dims = 1:20)

```

## assign celltypes
```{r assign cell types}
## based on markers 
seurat$clusterLabel <- "MacrophagesMonocytes"
seurat$clusterLabel[which(seurat$seurat_clusters == "3")] <- "Bcells"
seurat$clusterLabel[which(seurat$seurat_clusters %in% c("1", "12"))] <- "Tcells"
seurat$clusterLabel[which(seurat$seurat_clusters %in% c("2", "9"))] <- "NKcells"
seurat$clusterLabel[which(seurat$seurat_clusters %in% c("5", "6", "16"))] <- "Neutrophils"
seurat$clusterLabel[which(seurat$seurat_clusters %in% c("11", "15"))] <- "proliferating"
seurat$clusterLabel[which(seurat$seurat_clusters == "8")] <- "DCs"
seurat$clusterLabel[which(seurat$seurat_clusters == "10")] <- "ILCs"
#seurat$clusterLabel[which(seurat$seurat_clusters == "12")] <- "pDCs"
seurat$clusterLabel[which(seurat$seurat_clusters == "14")] <- "Basophils"

seurat$label_plus_cond <- paste0(seurat$clusterLabel, "_", seurat$grp)
```



## color vectors
```{r colVec}

colPal <- pal_igv()(length(levels(seurat)))
colGrp <- pal_jama()(length(unique(seurat$grp)))
colSmp <- pal_uchicago()(length(unique(seurat$dataset)))
colLab <- pal_futurama()(length(unique(seurat$clusterLabel)))

names(colPal) <- levels(seurat)
names(colGrp) <- unique(seurat$grp)
names(colSmp) <- unique(seurat$dataset)
names(colLab) <- unique(seurat$clusterLabel)
```


## vis data {.tabset}
### clusters
```{r vis cluster}
DimPlot(seurat, reduction = "umap", cols=colPal)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```

### group
```{r vis grp}

DimPlot(seurat, reduction = "umap", group.by = "grp", cols=colGrp)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

```

### label
```{r vis label}

DimPlot(seurat, reduction = "umap", group.by = "clusterLabel", cols=colLab)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

```

## cell counts {.tabset}

### overall cell counts
```{r overall cell counts}
dim(seurat)[2]
```

### counts per group
```{r counts per group}
knitr::kable(table(seurat$grp))

```

### counts per label and group
```{r counts per label and group}

knitr::kable(table(seurat$label_plus_cond))

```


### counts per cluster and group
```{r counts per cluster and group}

knitr::kable(table(seurat$cluster_plus_cond))

```


## marker genes
```{r marker genes}

seurat_markers_all <- FindAllMarkers(object = seurat, assay ="RNA",
                                     only.pos = TRUE, min.pct = 0.25,
                                     logfc.threshold = 0.25,
                                     test.use = "wilcox")

```


```{r avg heatmap function, eval=T, include=FALSE}

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(label=gsub("^.*\\.", "", gene))
  ## format gene names (depends on how gene list is inputed)
  selGenes <- selGenes %>% 
      mutate(labelNam = (str_split(gene, '\\.', simplify = T)[,2])) %>% 
    filter(labelNam %in% genes$label)
  #selGenes <- selGenes$labelNam
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  #genes <- data.frame(gene=rownames(seurat)) %>% 
  #  mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% selGenes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  #genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(gsub("(^.*?_)","",
                                       colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=gsub("(_.*$)","",colnames(logNormExpresMa)))
  colnames(annotation_col)[1] <- "col1"
  annotation_col <- annotation_col %>%
    dplyr::mutate(cond = gsub("(^[0-9]_?)","",col1)) %>%
    dplyr::select(cond, celltype)
  rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colVecCond,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes$labelNam,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

```

## vis cluster characterization
```{r vis cluster characteization, fig.height=10, fig.width=12}

selMarker <- read_tsv(paste0(basedir, "/docs/markerGenesHemato.txt"))
genes <- data.frame(gene=rownames(seurat)) %>% mutate(geneID=gsub("^.*\\.", "", gene))
selMarkerAll <- selMarker %>% left_join(., genes, by="geneID")

grpCnt <- selMarker %>% group_by(Cluster) %>% summarise(cnt=n())
gapR <- data.frame(Cluster=unique(selMarker$Cluster)) %>% 
  left_join(.,grpCnt, by="Cluster") %>% mutate(cumSum=cumsum(cnt)) 

Idents(seurat) <- seurat$seurat_clusters
avgHeatmap(seurat = seurat, selGenes = selMarkerAll,
                  colVecIdent = colPal, 
                  ordVec=levels(seurat)[order(levels(seurat))],
                  gapVecR=gapR$cumSum, gapVecC=NULL,cc=T,
                  cr=F, condCol=F)

Idents(seurat) <- seurat$clusterLabel
avgHeatmap(seurat = seurat, selGenes = selMarkerAll,
                  colVecIdent = colLab, 
                  ordVec=levels(seurat)[order(levels(seurat))],
                  gapVecR=gapR$cumSum, gapVecC=NULL,cc=T,
                  cr=F, condCol=F)


Idents(seurat) <- seurat$label_plus_cond
avgHeatmap(seurat = seurat, selGenes = selMarkerAll,
                  colVecIdent = colLab, colVecCond = colGrp, 
                  ordVec=levels(seurat)[order(levels(seurat))],
                  gapVecR=gapR$cumSum, gapVecC=NULL,cc=T,
                  cr=F, condCol=T)

avgHeatmap(seurat = seurat, selGenes = selMarkerAll,
                  colVecIdent = colLab, colVecCond = colGrp, 
                  ordVec=levels(seurat)[order(levels(seurat))],
                  gapVecR=gapR$cumSum, gapVecC=NULL,cc=F,
                  cr=F, condCol=T)


```



## overall DE genes
```{r overall DE, fig.height=8, fig.width=10}

Idents(seurat) <- seurat$grp

DEgenes <- FindAllMarkers(object = seurat, assay ="RNA",
                                     only.pos = TRUE, min.pct = 0.25,
                                     logfc.threshold = 0.25,
                                     test.use = "wilcox")

### plot DE genes top 15 avg logFC
DEGenesAll <- DEgenes %>% group_by(cluster) %>% 
  top_n(15, avg_log2FC)

Idents(seurat) <- seurat$cluster_plus_cond
avgHeatmap(seurat = seurat, selGenes = DEGenesAll,
                  colVecIdent = colPal, colVecCond = colGrp, 
                  ordVec=levels(seurat)[order(levels(seurat))],
                  gapVecR=NULL, gapVecC=NULL,cc=F,
                  cr=T, condCol=T)

Idents(seurat) <- seurat$label_plus_cond
avgHeatmap(seurat = seurat, selGenes = DEGenesAll,
                  colVecIdent = colLab, colVecCond = colGrp, 
                  ordVec=levels(seurat)[order(levels(seurat))],
                  gapVecR=NULL, gapVecC=NULL,cc=F,
                  cr=T, condCol=T)

```



## clusterwise DE genes

```{r clusterwise DE genes}

Idents(seurat) <- seurat$grp
seurat$clusterLabel <- as.factor(seurat$clusterLabel)
grpVec <- levels(seurat$clusterLabel)

clustDE <- lapply(grpVec, function(grp){
  grpSub <- levels(seurat$clusterLabel)[which(levels(seurat$clusterLabel)==grp)]
  seuratSub <- subset(seurat, clusterLabel == grpSub)
  DEgenes <-FindAllMarkers(seuratSub, only.pos=T, logfc.threshold = 0.25,
                           min.pct = 0.1)
  DEgenes <- DEgenes %>% filter(p_val_adj<0.01) %>%
    mutate(group=paste0(grp, "_", cluster))
})

names(clustDE) <- grpVec

clustDE_Dat <- data.frame(do.call("rbind", clustDE))
```



### avg Heatmap top cwDE genes {.tabset}
```{r avgHeat cwDE, warning=FALSE, echo = FALSE}

## only cluster with > 1 DE genes
deCnt <- lapply(clustDE, nrow)
deCnt <- data.frame(cnt=do.call("rbind", deCnt)) %>%
  rownames_to_column(var = "cluster") %>% filter(cnt>1)

grpVec <- as.character(deCnt$cluster)
seurat$label_plus_cond <- as.factor(seurat$label_plus_cond)
Idents(seurat) <- seurat$label_plus_cond

template_ah <- c(
    "#### {{grp}}\n",
    "```{r avgHeat cwDE {{grp}}, echo = FALSE, fig.height=10, fig.width=10}\n",
    "DeSub <- clustDE[[as.character('{{grp}}')]]",
    "DeSel <- DeSub %>% top_n(., 30, avg_log2FC)",
    "gapVecCol <- seq(2, length(levels(seurat$label_plus_cond)), by=2)",
    "pOut <- avgHeatmap(seurat = seurat, selGenes = DeSel,
                     colVecIdent = colLab, colVecCond=colGrp,
                     ordVec=levels(seurat$label_plus_cond),
                     gapVecR=NULL, gapVecC=gapVecCol,cc=FALSE,
                     cr=T, condCol=T)\n",
    "```\n",
    "\n"
)
    
plots_ah <- lapply(grpVec, 
  function(grp) knitr::knit_expand(text = template_ah)
)

```

`r knitr::knit(text = unlist(plots_ah))`


## save objects
```{r save}
Idents(seurat) <- seurat$seurat_clusters
saveRDS(seurat, file = paste0(basedir, 
                              "/data/Mu_Heart_TCRMplusLM_CD45_seurat.rds"))

write.table(seurat_markers_all,
            file=paste0(basedir, "/data/Mu_Heart_TCRMplusLM_CD45_markerGenes.txt"),
            row.names = FALSE, col.names = TRUE, quote = FALSE, sep = "\t")

write.table(DEgenes,
            file=paste0(basedir,
                        "/data/Mu_Heart_TCRMplusLM_CD45_overall_DEGenes.txt"),
            row.names = FALSE, col.names = TRUE, quote = FALSE, sep = "\t")

write.table(clustDE_Dat,
            file=paste0(basedir,
                        "/data/Mu_Heart_TCRMplusLM_CD45_cwDEGenes.txt"),
            row.names = FALSE, col.names = TRUE, quote = FALSE, sep = "\t")

```



## GSEA clusterProfiler overall DE genes {.tabset}
### overall DE genes LM_CD45 enriched
```{r GSEA clusterprofiler LM_CD45, fig.height=6, fig.width=12}


DEgenesCond <- DEgenes %>% filter(cluster == "LM_CD45") %>%
  mutate(EnsID = gsub("\\..*$", "", gene))

egoLM <- enrichGO(gene         = DEgenesCond$EnsID,
                OrgDb         = org.Mm.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)
egoLM <- setReadable(egoLM, OrgDb = org.Mm.eg.db)
dotplot(egoLM, showCategory=30)
cnetplot(egoLM, node_label="all") 
egoLM <- pairwise_termsim(egoLM)
emapplot(egoLM, showCategory = 15)


```

### overall DE genes TCRM_CD45 enriched
```{r GSEA clusterprofiler TCRM_CD45, fig.height=8, fig.width=18}


DEgenesCond <- DEgenes %>% filter(cluster == "TCRM_CD45") %>%
  mutate(EnsID = gsub("\\..*$", "", gene))

egoLM <- enrichGO(gene         = DEgenesCond$EnsID,
                OrgDb         = org.Mm.eg.db,
                keyType       = 'ENSEMBL',
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)
egoLM <- setReadable(egoLM, OrgDb = org.Mm.eg.db)
dotplot(egoLM, showCategory=30)
cnetplot(egoLM, node_label="all") 
egoLM <- pairwise_termsim(egoLM)
emapplot(egoLM, showCategory = 15)


```

## GSEA clusterProfiler clusterwise DE genes {.tabset}
### LM_CD45 enriched  {.tabset}
```{r GSEA cwDE LM_CD45, fig.height=6, fig.width=12}

clustDE_DatGSEA <- clustDE_Dat %>% 
  mutate(clusterLabel=gsub("_.*$", "", group)) %>% 
  filter(cluster == "LM_CD45") %>%
  mutate(EnsID = gsub("\\..*$", "", gene))


grpVec <- as.character(unique(clustDE_DatGSEA$clusterLabel))

template_ep <- c(
    "#### {{grp}}\n",
    "```{r GSEA cwDE LM_CD45 {{grp}}, echo=FALSE,fig.height=10,fig.width=10}\n",
    "DeSub <- clustDE_DatGSEA[which(
                    clustDE_DatGSEA$clusterLabel == as.character('{{grp}}')),]",
    "egoLM <- enrichGO(gene   = DeSub$EnsID,
                OrgDb         = org.Mm.eg.db,
                keyType       = 'ENSEMBL',
                ont           = 'BP',
                pAdjustMethod = 'BH',
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)",
    "if(max(egoLM@result$Count) < 2){
      egoLM <- NULL
    }",
    "if(!is.null(egoLM)){
      egoLM <- setReadable(egoLM, OrgDb = org.Mm.eg.db)
      dotplot(egoLM, showCategory=30)
    }",
    "if(!is.null(egoLM)){
      cnetplot(egoLM, node_label='all')
    }",
    "if(!is.null(egoLM)){
      egoLM <- pairwise_termsim(egoLM)
      emapplot(egoLM, showCategory = 15)
    }\n",
    "```\n",
    "\n"
)
    
plots_ep <- lapply(grpVec, 
  function(grp) knitr::knit_expand(text = template_ep)
)

```

`r knitr::knit(text = unlist(plots_ep))`


### TCRM_CD45 enriched {.tabset}
```{r GSEA cwDE TCRM_CD45, fig.height=6, fig.width=12}

clustDE_DatGSEA <- clustDE_Dat %>% 
  mutate(clusterLabel=gsub("_.*$", "", group)) %>% 
  filter(cluster == "TCRM_CD45") %>%
  mutate(EnsID = gsub("\\..*$", "", gene))


grpVec <- as.character(unique(clustDE_DatGSEA$clusterLabel))

template_ep <- c(
    "#### {{grp}}\n",
    "```{r GSEA cwDE TCRM_CD45 {{grp}},echo=FALSE,fig.height=10,fig.width=18}\n",
    "DeSub <- clustDE_DatGSEA[which(
                    clustDE_DatGSEA$clusterLabel == as.character('{{grp}}')),]",
    "egoLM <- enrichGO(gene   = DeSub$EnsID,
                OrgDb         = org.Mm.eg.db,
                keyType       = 'ENSEMBL',
                ont           = 'BP',
                pAdjustMethod = 'BH',
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.05)",
    "if(max(egoLM@result$Count) < 2){
      egoLM <- NULL
    }",
    "if(!is.null(egoLM)){
      egoLM <- setReadable(egoLM, OrgDb = org.Mm.eg.db)
      dotplot(egoLM, showCategory=30)
    }",
    "if(!is.null(egoLM)){
      cnetplot(egoLM, node_label='all')
    }",
    "if(!is.null(egoLM)){
      egoLM <- pairwise_termsim(egoLM)
      emapplot(egoLM, showCategory = 15)
    }\n",
    "```\n",
    "\n"
)
    
plots_ep <- lapply(grpVec, 
  function(grp) knitr::knit_expand(text = template_ep)
)

```

`r knitr::knit(text = unlist(plots_ep))`



## session info
```{r session info}
sessionInfo()
date()
```




