---
title: "Analyse balbc LN samples"
author: "Mechthild LÃ¼tge"
date: "24 July 2020"
output:
  html_document:
    self_contained: no
    code_folding: show
    number_sections: no
    toc: yes
    toc_depth: 3
    toc_float: true
    collapsed: no
    smooth_scroll: yes
---

```{r setup, echo = FALSE}
options(width = 100)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dev = c("png", "pdf"))
seed <- 1234
```


## load packages
```{r libs}
suppressPackageStartupMessages({
  library(SingleCellExperiment)
  library(tidyverse)
  library(Seurat)
  library(magrittr)
  library(dplyr)
  library(purrr)
  library(ggplot2)
  library(here)
  library(runSeurat3)
  library(ggsci)
  library(pheatmap)
  library(ggpubr)
  library(viridis)
})

```

## set dir
```{r set dir}
basedir <- here()
metaDat <- read_tsv(paste0(basedir, "/metadata_LN.txt"), col_names = T)

```


## load and assign samples
```{r load plus assign samples}

assignSamples <- function(smpNam, basedirSmp, smpGrp, smpBatch, smpLoc){
  smpNamFull <- list.files(path = paste0(basedirSmp, "/data/"),
				 pattern = paste0(smpNam, ".*_seurat.rds"))
  seuratSmp <- readRDS(paste0(basedirSmp, "/data/", smpNamFull))
  seuratSmp$grp <- smpGrp
  seuratSmp$batch <- smpBatch
  seuratSmp$loc <- smpLoc
  return(seuratSmp)
}

####################################################################

for(i in 1:length(metaDat$Sample)){
  seuratX <- assignSamples(smpNam = metaDat$Sample[i],
                           basedirSmp = basedir,
                           smpGrp = metaDat$group[i],
                           smpBatch = metaDat$batch[i],
                           smpLoc = metaDat$location[i])
  if(exists("seurat")){
    seurat <- merge(x = seurat, y = seuratX, project = "balbC_LN")
  }else{
    seurat <- seuratX
  }
}

remove(seuratX)

```



## run clustering and DR and remove contaminating cells
```{r clustering and DR}
## remove contaminants
seurat <- subset(seurat, subset = ENSMUSG00000026395.Ptprc >0, invert=T)
seurat <- subset(seurat, subset = ENSMUSG00000003379.Cd79a >0, invert=T)
seurat <- subset(seurat, subset = ENSMUSG00000040592.Cd79b >0, invert=T)
seurat <- subset(seurat, subset = ENSMUSG00000076928.Trac >0, invert=T)
seurat <- subset(seurat, subset = ENSMUSG00000032094.Cd3d >0, invert=T)

seurat <- rerunSeurat3(seurat)

dat <- data.frame(table(seurat$dataset))
colnames(dat) <- c("dataset", "all")

seuratSub <- subset(seurat, subset = ENSMUSG00000074934.Grem1 >0) ## 0 cells
dat2 <- data.frame(table(seuratSub$dataset))
colnames(dat2) <- c("dataset", "Grem1")
dat <- dat %>% left_join(., dat2, by=c("dataset"))

seuratSub <- subset(seurat, subset = ENSMUSG00000050069.Grem2 >0) ## 2 cells
dat2 <- data.frame(table(seuratSub$dataset))
colnames(dat2) <- c("dataset", "Grem2")
dat <- dat %>% left_join(., dat2, by=c("dataset"))

seuratSub <- subset(seurat, subset = ENSMUSG00000027358.Bmp2 >0) ## 418 cells
dat2 <- data.frame(table(seuratSub$dataset))
colnames(dat2) <- c("dataset", "Bmp2")
dat <- dat %>% left_join(., dat2, by=c("dataset"))

seuratSub <- subset(seurat,subset = ENSMUSG00000021835.Bmp4 >0) ## 1341 cells
dat2 <- data.frame(table(seuratSub$dataset))
colnames(dat2) <- c("dataset", "Bmp4")
dat <- dat %>% left_join(., dat2, by=c("dataset"))

seuratSub <- subset(seurat,subset= ENSMUSG00000021796.Bmpr1a >0) ## 1092 cells
dat2 <- data.frame(table(seuratSub$dataset))
colnames(dat2) <- c("dataset", "Bmpr1a")
dat <- dat %>% left_join(., dat2, by=c("dataset"))

seuratSub <- subset(seurat, subset=ENSMUSG00000052430.Bmpr1b >0) ## 2 cells
dat2 <- data.frame(table(seuratSub$dataset))
colnames(dat2) <- c("dataset", "Bmpr1b")
dat <- dat %>% left_join(., dat2, by=c("dataset"))

seuratSub <- subset(seurat,subset= ENSMUSG00000067336.Bmpr2 >0) ## 2201 cells
dat2 <- data.frame(table(seuratSub$dataset))
colnames(dat2) <- c("dataset", "Bmpr2")
dat <- dat %>% left_join(., dat2, by=c("dataset"))
dat[is.na(dat)] <-0

dat_fin <-  dat %>%
  bind_rows(summarise_all(., funs(if(is.numeric(.)) sum(.) else "total")))

knitr::kable(dat_fin)

## total 71484 cells

```

## check QC
```{r check QC}

colDat <- pal_npg()(length(unique(seurat$dataset)))
names(colDat) <- unique(seurat$dataset)

sce <- as.SingleCellExperiment(seurat)

plotQC2 <- function(sce, feature){
  p <- gghistogram(data = as.data.frame(sce@colData),
              x=feature,
              bins=70,
              #title=unique(sce$dataset),
              fill = "dataset",
              palette = colDat,
              legend = "right")
  return(p)
}

plotQC3 <- function(sce, feature){
  p <- gghistogram(data = as.data.frame(sce@colData),
              x=feature,
              y = "..density..",
              bins=70,
              fill = "dataset",
              palette = colDat,
              add_density = TRUE,
              legend = "right")
  return(p)
}

plotQC2(sce, "total_counts")
plotQC3(sce, "total_counts")

plotQC2(sce, "total_features_by_counts")
plotQC3(sce, "total_features_by_counts")

#plotQC2(sce, "pct_counts_Mt")
#plotQC3(sce, "pct_counts_Mt")

plotQC2(sce, "pct_counts_in_top_500_features")
plotQC3(sce, "pct_counts_in_top_500_features")

#plotQC2(sce, "pct_counts_endogenous")
#plotQC3(sce, "pct_counts_endogenous")

#plotQC2(sce, "total_features_by_counts_Mt")
#plotQC3(sce, "total_features_by_counts_Mt")

#plotQC2(sce, "total_counts_Mt")
#plotQC3(sce, "total_counts_Mt")

#plotQC2(sce, "pct_counts_in_top_500_features_endogenous")
#plotQC3(sce, "pct_counts_in_top_500_features_endogenous")


```


## subset on med LN
```{r subset med LN}

seurat <- subset(seurat, loc == "medLN")
seurat <- rerunSeurat3(seurat)

## remove cluster with lymphocytes and epithelial cells:
seurat <- subset(seurat, idents = c("3", "10", "6"), invert=T)

## rerun DR
seurat <- RunPCA(object = seurat, npcs = 30, verbose = FALSE)
seurat <- RunTSNE(object = seurat, reduction = "pca", dims = 1:20)
seurat <- RunUMAP(object = seurat, reduction = "pca", dims = 1:20)

```


## color vectors
```{r colVec}

colPal <- pal_igv()(length(levels(seurat)))
colGrp <- pal_jama()(length(unique(seurat$grp)))
colSmp <- pal_uchicago()(length(unique(seurat$dataset)))

names(colPal) <- levels(seurat)
names(colGrp) <- unique(seurat$grp)
names(colSmp) <- unique(seurat$dataset)
```


## vis data {.tabset}
### clusters
```{r vis cluster}

DimPlot(seurat, reduction = "umap", cols=colPal)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```

### group
```{r vis grp}

DimPlot(seurat, reduction = "umap", group.by = "grp", cols=colGrp)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")

```


### Sample
```{r vis sample}

DimPlot(seurat, reduction = "umap", group.by = "dataset", cols=colSmp)+
  theme_bw() +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), 
        panel.grid.minor = element_blank()) +
  xlab("UMAP1") +
  ylab("UMAP2")


```


## marker genes
```{r marker genes}

seurat_markers_all <- FindAllMarkers(object = seurat, assay ="RNA",
                                     only.pos = TRUE, min.pct = 0.25,
                                     logfc.threshold = 0.25,
                                     test.use = "wilcox")

```


```{r avg heatmap function, eval=T, include=T}

avgHeatmap <- function(seurat, selGenes, colVecIdent, colVecCond=NULL,
                       ordVec=NULL, gapVecR=NULL, gapVecC=NULL,cc=FALSE,
                       cr=FALSE, condCol=FALSE){
  
  selGenes <- selGenes$gene
  
  ## assay data
  clusterAssigned <- as.data.frame(Idents(seurat)) %>%
  dplyr::mutate(cell=rownames(.))
  colnames(clusterAssigned)[1] <- "ident"
  seuratDat <- GetAssayData(seurat)
  
  ## genes of interest
  genes <- data.frame(gene=rownames(seurat)) %>% 
    mutate(geneID=gsub("^.*\\.", "", gene)) %>% filter(geneID %in% selGenes)

  ## matrix with averaged cnts per ident
  logNormExpres <- as.data.frame(t(as.matrix(
    seuratDat[which(rownames(seuratDat) %in% genes$gene),])))
  logNormExpres <- logNormExpres %>% dplyr::mutate(cell=rownames(.)) %>%
    dplyr::left_join(.,clusterAssigned, by=c("cell")) %>%
    dplyr::select(-cell) %>% dplyr::group_by(ident) %>%
    dplyr::summarise_all(mean)
  logNormExpresMa <- logNormExpres %>% dplyr::select(-ident) %>% as.matrix()
  rownames(logNormExpresMa) <- logNormExpres$ident
  logNormExpresMa <- t(logNormExpresMa)
  rownames(logNormExpresMa) <- gsub("^.*?\\.","",rownames(logNormExpresMa))
  
  ## remove genes if they are all the same in all groups
  ind <- apply(logNormExpresMa, 1, sd) == 0
  logNormExpresMa <- logNormExpresMa[!ind,]
  genes <- genes[!ind,]

  ## color columns according to cluster
  annotation_col <- as.data.frame(gsub("(^.*?_)","",
                                       colnames(logNormExpresMa)))%>%
    dplyr::mutate(celltype=gsub("(_.*$)","",colnames(logNormExpresMa)))
  colnames(annotation_col)[1] <- "col1"
  annotation_col <- annotation_col %>%
    dplyr::mutate(cond = gsub("(^[0-9]_?)","",col1)) %>%
    dplyr::select(cond, celltype)
  rownames(annotation_col) <- colnames(logNormExpresMa) 

  ann_colors = list(
      cond = colVecCond,
      celltype=colVecIdent)
  if(is.null(ann_colors$cond)){
    annotation_col$cond <- NULL
  }
  
  ## adjust order
  logNormExpresMa <- logNormExpresMa[selGenes,]
  if(is.null(ordVec)){
    ordVec <- levels(seurat)
  }
  logNormExpresMa <- logNormExpresMa[,ordVec]

  ## scaled row-wise
  pheatmap(logNormExpresMa, scale="row" ,treeheight_row = 0, cluster_rows = cr, 
         cluster_cols = cc,
         color = colorRampPalette(c("#2166AC", "#F7F7F7", "#B2182B"))(50),
         annotation_col = annotation_col, cellwidth=15, cellheight=10,
         annotation_colors = ann_colors, gaps_row = gapVecR, gaps_col = gapVecC)
}

```


## cluster cnts
```{r cluster cnts}
seurat$cluster_plus_grp <- paste0(seurat$seurat_clusters, "_", seurat$grp)

dat_grp <- data.frame(table(seurat$grp))

dat_cl <- data.frame(table(seurat$seurat_clusters, seurat$grp))
dat_cl <- spread(dat_cl, Var2, Freq) %>%
  mutate(FreqLM=LM/dat_grp$Freq[which(dat_grp$Var1=="LM")]) %>% 
  mutate(FreqTCRM=TCRM/dat_grp$Freq[which(dat_grp$Var1=="TCRM")])

knitr::kable(dat_cl)

```


## vis Grem and BMPs {.tabset}
### Grem1
```{r vis Grem1}
p <- FeaturePlot(seurat, reduction = "umap", 
            features = "ENSMUSG00000074934.Grem1",
            cols=c("lightgrey", "darkred"),
            order = T)+
  theme(legend.position="right")
p

```

### Grem2
```{r vis Grem2}
p <- FeaturePlot(seurat, reduction = "umap", 
            features = "ENSMUSG00000050069.Grem2",
            cols=c("lightgrey", "darkred"),
            order = T)+
  theme(legend.position="right")
p

```


### Bmp2
```{r vis Bmp2}
p <- FeaturePlot(seurat, reduction = "umap", 
            features = "ENSMUSG00000027358.Bmp2",
            cols=c("lightgrey", "darkred"),
            order = T)+
  theme(legend.position="right")
p

```

### Bmp4
```{r vis Bmp4}
p <- FeaturePlot(seurat, reduction = "umap", 
            features = "ENSMUSG00000021835.Bmp4",
            cols=c("lightgrey", "darkred"),
            order = T)+
  theme(legend.position="right")
p

```

### Bmpr1a
```{r vis Bmpr1a}
p <- FeaturePlot(seurat, reduction = "umap", 
            features = "ENSMUSG00000021796.Bmpr1a",
            cols=c("lightgrey", "darkred"),
            order = T)+
  theme(legend.position="right")
p

```

### Bmpr2
```{r vis Bmpr2}
p <- FeaturePlot(seurat, reduction = "umap", 
            features = "ENSMUSG00000052430.Bmpr1b",
            cols=c("lightgrey", "darkred"),
            order = T)+
  theme(legend.position="right")
p

```


## plot selected marker
```{r sel marker, fig.height=10, fig.width=7}

selMarker <- list(LZFDC = c("Fcer2a", "Cr2", "Cxcl13", "Madcam1"),
                  DZFDC = c("Pdlim3", "Crym"),
                  MRC = c("Tnfsf11", "Cavin2", "Hamp2"),
                  TRC_TBRC = c("Prelp", "Fmod", "Ccl21a",
                               "Ccl19", "Vtn", "Ifitm1"),
                  iTBRC = c("Cd74", "H2-Ab1", "H2-Aa"),                  
                  Cxcl9BRC = c("Cxcl9", "Cxcl10", "Irgm1", "Irf7"),
                  medRC = c("Cxcl1", "Cxcl2","Ccl2", "Ccl7", "Nr4a1"),
                  adventitial = c("Cd34", "Ly6c1", "Igfbp6"),
                  endothelial=c("Pecam1"))

selGenes <- data.frame(gene=unlist(selMarker)) %>%
  rownames_to_column(var="grp") %>% mutate(Grp=gsub(".{1}$", "", grp))
grpCnt <- selGenes %>% group_by(Grp) %>% summarise(cnt=n())
gapR <- data.frame(Grp=unique(selGenes$Grp)) %>% 
  left_join(.,grpCnt, by="Grp") %>% mutate(cumSum=cumsum(cnt)) 
#ordVec <- levels(seurat)[c(10,7,6,8,2,1,5,4,3,9)]

pOut <- avgHeatmap(seurat = seurat, selGenes = selGenes,
                  colVecIdent = colPal, 
#                  ordVec=ordVec,
                  gapVecR=gapR$cumSum, gapVecC=NULL,cc=T,
                  cr=F, condCol=F)

```


## DE genes FRCs
```{r overall DE, fig.height=10, fig.width=6}

seuratSub <- subset(seurat, idents=c("0", "2", "9"))
Idents(seuratSub) <- seuratSub$grp

DEgenes <- FindAllMarkers(object = seuratSub, assay ="RNA",
                                     only.pos = TRUE, min.pct = 0.25,
                                     logfc.threshold = 0.25,
                                     test.use = "wilcox")

### plot DE genes top 15 avg logFC
# DEGenesAll <- DEgenes %>% group_by(cluster) %>% 
#   top_n(15, avg_logFC)
# 
# Idents(seurat) <- seurat$seurat_clusters
# avgHeatmap(seurat = seurat, selGenes = DEGenesAll,
#                   colVecIdent = colPal, 
#                   ordVec=levels(seurat),
#                   gapVecR=NULL, gapVecC=NULL,cc=T,
#                   cr=T, condCol=F)
```


### vis DE genes {.tabset}
#### scatterplot
```{r vis DE genes, fig.height=8, fig.width=9}

allID <- seuratSub
Idents(allID) <- seuratSub$grp
avg.allID <- AverageExpression(allID, show.progress = FALSE)
avg.allID <- log1p(avg.allID$RNA)

avg.allID$gene <- rownames(avg.allID)

## expression frequency
GeneFreqSel <- as.data.frame(GetAssayData(allID, assay = "RNA",
                                          slot = "data")) %>%
  tibble::rownames_to_column(var="gene") %>% mutate(count=rowSums(.!=0)-1) %>%
  mutate(countFreq=count/ncol(allID)) %>% select(gene,count, countFreq) %>%
  dplyr::filter(countFreq>=0.1)

signGenes2 <- DEgenes %>% 
  dplyr::filter(p_val_adj<0.01 & (avg_logFC > 0.25 | avg_logFC < -0.25)) 

signGenes3 <- DEgenes %>% group_by(cluster) %>% top_n(., 15, avg_logFC) %>% 
  mutate(labelNam=gsub("^.*\\.", "", gene)) %>% filter(labelNam != "1")

genes.to.label = c("Bmp1", "Bmp2", "Bmpr1a", "Grem1", "Grem2",
                   "Tgfb1", "Tgfb2", "Tgfb3", signGenes3$labelNam)

avg.allID <- avg.allID %>% mutate(labelNam=gsub("^.*\\.", "", gene)) %>%
  mutate(colourGrp=ifelse(labelNam %in% genes.to.label, "lab",
                          ifelse(gene%in%signGenes2$gene, "sig", "notSig"))) %>%
  dplyr::filter(gene%in%GeneFreqSel$gene)


p_allID <- ggscatter(avg.allID, x="TCRM", y="LM",
                    color = "colourGrp",
                    #fill = "colourGrp",
                    palette = c("#660000", "#808080", "#FF3333"),
                    label="labelNam",
                    label.select = genes.to.label,
                    repel = F,
                    label.rectangle=F,
                    xlab="TCRM",
                    ylab = "LM",
                    title="",
                    legend="none",
                    font.label=10,
                    alpha=0.9,
                    xlim = c(0, 5),
                    ylim = c(0, 5),
                    size=0.5)


p_allID 

genes.to.label = c("Bmp1", "Bmp2", "Bmpr1a", "Grem1", "Grem2",
                   "Tgfb1", "Tgfb2", "Tgfb3")

avg.allID <- avg.allID %>% mutate(labelNam=gsub("^.*\\.", "", gene)) %>%
  mutate(colourGrp=ifelse(labelNam %in% genes.to.label, "lab",
                          ifelse(gene%in%signGenes2$gene, "sig", "notSig"))) %>%
  dplyr::filter(gene%in%GeneFreqSel$gene)


p_allID <- ggscatter(avg.allID, x="TCRM", y="LM",
                    color = "colourGrp",
                    #fill = "colourGrp",
                    palette = c("#660000", "#808080", "#FF3333"),
                    label="labelNam",
                    label.select = genes.to.label,
                    repel = F,
                    label.rectangle=F,
                    xlab="TCRM",
                    ylab = "LM",
                    title="",
                    legend="none",
                    font.label=10,
                    alpha=0.9,
                    xlim = c(0, 5),
                    ylim = c(0, 5),
                    size=0.5)


p_allID 

```

#### Dotplot cond
```{r dotplot}
Idents(seuratSub) <- seuratSub$grp
genesSel <- data.frame(gene=rownames(seuratSub)) %>%
  mutate(labelNam=gsub("^.*\\.", "", gene)) %>% 
  filter(labelNam %in% genes.to.label)

DotPlot(seuratSub, features =  genesSel$gene, group.by= "grp") +
  RotatedAxis() +
  scale_color_viridis(option = "D")

```

#### clusterwise Dotplot cond
```{r dotplot cw, fig.height=8, fig.width=7}
Idents(seuratSub) <- seuratSub$seurat_clusters
genesSel <- data.frame(gene=rownames(seuratSub)) %>%
  mutate(labelNam=gsub("^.*\\.", "", gene)) %>% 
  filter(labelNam %in% genes.to.label)


DotPlot(seuratSub, features = genesSel$gene, group.by= "cluster_plus_grp") +
  RotatedAxis() +
  scale_color_viridis(option = "D") 
```

#### selected genes heatmap across FRC cluster
```{r sel genes heatmap}
### all FRC cluster here!!
seuratSub <- subset(seurat, idents=c("0", "2", "9", "4"))
Idents(seuratSub) <- seuratSub$seurat_clusters

colnames(genesSel) <- c("geneID", "gene")
pOut <- avgHeatmap(seurat = seuratSub, selGenes = genesSel,
                  colVecIdent = colPal, 
#                  ordVec=ordVec,
                  gapVecR=NULL, gapVecC=NULL,cc=T,
                  cr=T, condCol=F)

```


## save objects
```{r save}
Idents(seurat) <- seurat$seurat_clusters
saveRDS(seurat, file = paste0(basedir, "/data/BalbcMedLN_seurat.rds"))

write.table(seurat_markers_all,
            file=paste0(basedir, "/data/BalbcMedLN_markerGenes.txt"),
            row.names = FALSE, col.names = TRUE, quote = FALSE, sep = "\t")

write.table(DEgenes,
            file=paste0(basedir, "/data/BalbcMedLN_FRC_DEGenes.txt"),
            row.names = FALSE, col.names = TRUE, quote = FALSE, sep = "\t")

```


## session info
```{r session info}
sessionInfo()
date()
```




